<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>El Tim√≥n ‚Äî App Completa (CodePen)</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --azul-oscuro:#003f70;
  --azul:#0078d7;
  --gris-100:#f4f6f8;
  --gris-300:#dfe7ee;
  --gris-350:#e9f2fb;
  --texto:#16202a;
  --radius:12px;
  --shadow:0 8px 24px rgba(0,0,0,0.08);
}
*{box-sizing:border-box}
body{margin:0;font-family:'Nunito',system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--gris-100);color:var(--texto);min-height:100vh;}
header{background:linear-gradient(135deg,var(--azul-oscuro),var(--azul));color:#fff;text-align:center;padding:20px 12px 12px;}
.title{font-weight:800;font-size:1.6rem;margin:0;}
.subtitle{margin-top:6px;color:rgba(255,255,255,0.95);font-weight:600;font-size:1rem;}
nav.topbar{position:sticky;top:0;z-index:999;background:var(--gris-350);border-bottom:1px solid var(--gris-300);padding:8px 12px;display:flex;gap:8px;align-items:center;justify-content:center;}
nav.topbar .btn{background:#fff;color:var(--azul);border:1px solid var(--gris-300);}

main.layout{max-width:1100px;margin:20px auto;padding:0 16px;display:flex;flex-direction:column;align-items:center;}
.card{background:#fff;border-radius:var(--radius);padding:16px;margin-bottom:14px;box-shadow:var(--shadow);border:1px solid var(--gris-300);width:100%;max-width:700px;}
.card:last-child{margin-bottom:40px;}
h2{margin:0 0 8px;color:var(--azul-oscuro)}

.btn{background:var(--azul);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700;display:inline-flex;align-items:center;justify-content:center;gap:6px;}
.btn.secondary{background:transparent;border:1px solid var(--gris-300);color:var(--azul)}
.btn.danger{background:#dc3545;color:#fff;border:0}
.btn.icon{width:30px;height:28px;font-size:14px;padding:0;line-height:1;}
@media (max-width:768px){.btn.icon{width:26px;height:26px;font-size:13px;}}

input,select,textarea{padding:8px;border-radius:8px;border:1px solid var(--gris-300);font-size:0.95rem;width:100%}

.main-menu{display:flex;flex-direction:column;gap:10px;align-items:center;}
.main-menu .btn{width:260px;text-align:center;}

.product-item{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px 10px;border-radius:8px;background:#fbfcfe;border:1px solid #eef5fb;margin-bottom:6px;}
.product-item .qty{flex:0 0 40px;max-width:40px;}
.product-item .qty input{width:100%;text-align:center;padding:4px;border-radius:6px;}
.product-item .um{flex:0 0 75px;max-width:75px;}
.product-item .um select{width:100%;padding:4px;border-radius:6px;}
.product-item .pname{flex:1 1 auto;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.product-item .chk{flex:0 0 auto;margin-right:2px;display:flex;align-items:center;}
.product-item .chk input{transform:scale(1.1);}

.proveedor-header{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:6px 8px;border-radius:8px;background:#eef5fb;border:1px solid #dfe7ee;margin-bottom:6px;font-weight:600;}
.proveedor-header .pname{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

.add-product-wrap{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;}
.add-product-wrap input{flex:1 1 auto;min-width:120px;}
.add-product-wrap button{flex:0 0 auto;}

.footer-actions{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;}

.hidden{display:none!important}

.view-animate{animation:fadeIn .35s ease;}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}

/* Resumen filtros layout */
.resumen-filtros{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
@media (max-width:768px){
  .resumen-filtros{display:grid!important;grid-template-columns:1fr 1fr;gap:8px;}
  .resumen-filtros label{display:flex;flex-direction:column;font-weight:600;}
  .resumen-filtros select,.resumen-filtros input{width:100%;}
  .resumen-filtros .btn{grid-column:1 / -1;justify-self:end;}
}

/* Toasts centrados y apilables */
#toastContainer{
  position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  z-index:99999;display:flex;flex-direction:column;align-items:center;gap:12px;
}
.toast{
  background:rgba(0,64,128,0.9);padding:16px 22px;border-radius:14px;color:#fff;
  font-weight:700;text-align:center;box-shadow:0 8px 28px rgba(0,0,0,0.3);
  opacity:0;animation:fadeInOut 2.6s ease forwards;
}
@keyframes fadeInOut{
  0%{opacity:0;transform:scale(0.9)}10%,90%{opacity:1;transform:scale(1)}100%{opacity:0;transform:scale(0.9)}
}
.toast.success{background:#2ea44f}
.toast.warn{background:#ffb74d}
.toast.error{background:#d9534f}

/* Modal m√≠nimo */
#modalOverlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:10000;}
#modalWindow{background:#fff;border-radius:12px;padding:16px;max-width:560px;width:90%;display:none;}
.modal-header{font-weight:800;font-size:1.2rem;margin-bottom:8px;color:var(--azul-oscuro)}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px;}
</style>
</head>
<body>

<header>
  <div class="title">El <strong>Tim√≥n</strong></div>
  <div class="subtitle">Pedidos a Proveedores</div>
</header>

<nav class="topbar">
  <button class="btn" onclick="showMain()">üè† Inicio</button>
</nav>

<main class="layout">

<section id="main" class="card">
  <h2>Men√∫ Principal</h2>
  <div class="main-menu">
    <button class="btn" onclick="showGestionProveedores()">Gesti√≥n de Proveedores</button>
    <button class="btn" onclick="showPedidos()">Pedidos</button>
    <button class="btn" onclick="showResumenPedidos()">Resumen General</button>
    <button class="btn" onclick="showBackup()">Copias de seguridad</button>
  </div>
</section>

<section id="view-proveedores" class="card hidden">
  <h2>Gesti√≥n de Proveedores</h2>
  <div style="margin-bottom:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
    <label>Proveedor</label>
    <select id="selectProveedorGestion"><option value="">-- Selecciona proveedor --</option></select>
    <button class="btn" onclick="showCrearProveedor()">Nuevo proveedor</button>
  </div>
  <div id="productosProveedorContainer"></div>
  <div class="footer-actions">
    <button class="btn secondary" onclick="goBackToMain()">Volver</button>
  </div>
</section>

<section id="view-crear" class="card hidden">
  <h2>Crear Proveedor</h2>
  <input id="nuevoProveedor" placeholder="Nombre del proveedor">
  <input id="telefonoProveedor" placeholder="Tel√©fono (ej: 34600111222)" style="margin-top:8px">
  <div style="margin-top:10px;display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap">
    <button class="btn" onclick="guardarProveedor()">Guardar</button>
    <button class="btn secondary" onclick="showGestionProveedores()">Cancelar</button>
  </div>
  <div class="footer-actions"><button class="btn secondary" onclick="goBackToMain()">Volver</button></div>
</section>

<section id="view-pedidos" class="card hidden">
  <h2>Pedidos</h2>
  <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
    <label>Proveedor</label>
    <select id="pedidoProveedorSelect"></select>
    <button class="btn" onclick="mostrarProductosPedido()">Mostrar</button>
  </div>
  <div id="productosPedido" style="margin-top:12px"></div>
  <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap">
    <button class="btn" onclick="enviarPedidoDesdePantalla()">Enviar</button>
    <button class="btn secondary" onclick="revisarPedidoDesdePantalla()">Revisar</button>
  </div>
  <div class="footer-actions"><button class="btn secondary" onclick="goBackToMain()">Volver</button></div>
</section>

<section id="view-resumen" class="card hidden">
  <h2>Resumen General de Pedidos</h2>
  <div class="resumen-filtros">
    <label>Proveedor</label><select id="resumenProveedorSelect"></select>
    <label>Desde <input type="date" id="resumenInicio"></label>
    <label>Hasta <input type="date" id="resumenFin"></label>
    <button class="btn" onclick="filtrarResumen()">Buscar</button>
  </div>
  <div id="historialContainer" style="margin-top:12px">
    <div style="opacity:.7">Selecciona un proveedor y pulsa <strong>Buscar</strong>.</div>
  </div>
  <div class="footer-actions"><button class="btn secondary" onclick="goBackToMain()">Volver</button></div>
</section>

<section id="backup" class="card hidden">
  <h2>Copias de seguridad</h2>
  <div style="display:flex;flex-direction:column;gap:10px;">
    <button class="btn" onclick="exportarDB()">üíæ Exportar datos</button>
    <input type="file" id="importFile" accept="application/json" style="display:none" onchange="importarDB(event)">
    <button class="btn secondary" onclick="document.getElementById('importFile').click()">üìÇ Importar datos</button>
  </div>
  <div class="footer-actions"><button class="btn secondary" onclick="goBackToMain()">Volver</button></div>
</section>

</main>

<div id="toastContainer"></div>
<div id="modalOverlay" class="hidden"><div id="modalWindow"></div></div>

<script>
/* ========== Helpers ========== */
const $ = s => document.querySelector(s);
const create = (tag, attrs = {}, children = '') => {
  const el = document.createElement(tag);
  Object.entries(attrs||{}).forEach(([k,v])=>{
    if(typeof v==='function') el[k] = v; else el.setAttribute(k,v);
  });
  if(typeof children==='string') el.innerHTML = children;
  else if(Array.isArray(children)) children.forEach(c=>el.appendChild(c));
  return el;
};
const escapeHtml = s => { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; };
function formatDT(ts){ const d=new Date(ts); const pad=n=>String(n).padStart(2,'0'); return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }

/* ========== DB local ========== */
const DB_KEY='db_timon_codepen_full';
let db = JSON.parse(localStorage.getItem(DB_KEY) || '{"proveedores":{},"pedidos":{}}');
function saveDB(){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }

/* ========== Toasts centrados/apilables ========== */
function showToast(msg,type='success'){
  const cont=$('#toastContainer');
  const t=document.createElement('div');
  t.className='toast '+type;
  t.textContent=msg;
  cont.appendChild(t);
  setTimeout(()=>{ t.remove(); }, 2600);
}

/* ========== Modal m√≠nimo ========== */
function showModal(title, html, actions = []){
  hideModal();
  const overlay=$('#modalOverlay'); const win=$('#modalWindow');
  win.innerHTML='';
  win.appendChild(create('div',{class:'modal-header'}, escapeHtml(title)));
  win.appendChild(create('div',{}, html));
  const acts=create('div',{class:'modal-actions'});
  actions.forEach(a=>{
    const btn=create('button',{class:'btn '+(a.variant||'')}, a.label||'');
    btn.onclick=()=>a.onClick?.();
    acts.appendChild(btn);
  });
  win.appendChild(acts);
  overlay.classList.remove('hidden'); win.style.display='block';
  overlay.onclick=(e)=>{ if(e.target===overlay) hideModal(); };
}
function hideModal(){ const w=$('#modalWindow'),o=$('#modalOverlay'); w.innerHTML=''; w.style.display='none'; o.classList.add('hidden'); }

/* ========== Navegaci√≥n y limpieza ========== */
function hideAll(){ document.querySelectorAll('main.layout > section').forEach(s=>s.classList.add('hidden')); }
function showMain(){ hideAll(); const el=$('#main'); el.classList.remove('hidden'); renderGestionProveedores(); updateAllSelects(); updateResumenSelect(); }
function showGestionProveedores(){ hideAll(); const el=$('#view-proveedores'); el.classList.remove('hidden'); renderGestionProveedores(); }
function showCrearProveedor(){ hideAll(); const el=$('#view-crear'); el.classList.remove('hidden'); $('#nuevoProveedor').value=''; $('#telefonoProveedor').value=''; }
function showPedidos(){ hideAll(); const el=$('#view-pedidos'); el.classList.remove('hidden'); updateAllSelects(); clearProductosPedido(); }
function showResumenPedidos(){ hideAll(); const el=$('#view-resumen'); el.classList.remove('hidden'); updateResumenSelect(); }
function showBackup(){ hideAll(); const el=$('#backup'); el.classList.remove('hidden'); }

/* ========== Selects ========== */
function updateAllSelects(){
  const selPedido=$('#pedidoProveedorSelect'), selGestion=$('#selectProveedorGestion');
  const provs=Object.keys(db.proveedores).sort((a,b)=>a.localeCompare(b,'es'));
  if(selPedido) selPedido.innerHTML = provs.map(p=>`<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join('') || '<option value="">-- Sin proveedores --</option>';
  if(selGestion) selGestion.innerHTML = '<option value="">-- Selecciona proveedor --</option>' + (provs.map(p=>`<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join(''));
}
function updateResumenSelect(){
  const sel=$('#resumenProveedorSelect');
  const provs=Object.keys(db.proveedores).sort((a,b)=>a.localeCompare(b,'es'));
  if(sel) sel.innerHTML = `<option value="">-- Selecciona proveedor --</option>` + provs.map(p=>`<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join('');
  if($('#resumenInicio')) $('#resumenInicio').value='';
  if($('#resumenFin')) $('#resumenFin').value='';
}

/* ========== Gesti√≥n de Proveedores ========== */
function guardarProveedor(){
  const n=($('#nuevoProveedor').value||'').trim(), t=($('#telefonoProveedor').value||'').trim();
  if(!n){ showToast('Pon un nombre.','warn'); return; }
  if(db.proveedores[n]){ showToast('Ese proveedor ya existe.','warn'); return; }
  db.proveedores[n] = { telefono: t, productos: [] };
  saveDB();
  updateAllSelects();
  updateResumenSelect();
  showGestionProveedores();
  const sel = $('#selectProveedorGestion'); if(sel) sel.value = n;
  renderGestionProveedores();
  showToast('Proveedor creado.');
}
function renderGestionProveedores(){
  const cont=$('#productosProveedorContainer'); cont.innerHTML='';
  const sel=$('#selectProveedorGestion'); if(!sel.dataset.bound){ sel.addEventListener('change',()=>renderGestionProveedores()); sel.dataset.bound='1'; }
  const prov=sel.value; if(!prov){ cont.innerHTML='<div style="opacity:.7">Selecciona un proveedor.</div>'; return; }
  const data=db.proveedores[prov]; if(!data){ cont.innerHTML='No encontrado.'; return; }

  const header=create('div',{class:'proveedor-header'}, `<div class="pname">üì¶ ${escapeHtml(prov)} ${data.telefono? `<span style="font-weight:400;opacity:.8">¬∑ ${escapeHtml(data.telefono)}</span>` : ''}</div>`);
  const ctrl=create('div',{style:'display:flex;gap:6px;align-items:center'});
  const btnEdit = create('button',{class:'btn icon secondary'},'‚úèÔ∏è');
  btnEdit.onclick = ()=>{
    const nuevoNombre = prompt('Nuevo nombre del proveedor:', prov);
    if(nuevoNombre && nuevoNombre.trim() && nuevoNombre !== prov){
      if(db.proveedores[nuevoNombre]){ showToast('Ya existe ese nombre.','warn'); return; }
      db.proveedores[nuevoNombre] = db.proveedores[prov]; delete db.proveedores[prov];
      saveDB(); $('#selectProveedorGestion').value = nuevoNombre; updateAllSelects(); updateResumenSelect(); showToast('Proveedor renombrado.');
    }
    const current = $('#selectProveedorGestion').value;
    const nuevoTel=prompt('Tel√©fono (con c√≥digo pa√≠s sin +):', db.proveedores[current].telefono||'');
    if(nuevoTel!==null){ db.proveedores[current].telefono = nuevoTel.trim(); saveDB(); renderGestionProveedores(); }
  };
  const btnDelete = create('button',{class:'btn icon danger'},'üóëÔ∏è');
  btnDelete.onclick = ()=>{
    const provName = prov;
    showModal('Eliminar proveedor', `<div>¬øSeguro que quieres eliminar <strong>${escapeHtml(provName)}</strong>? No afectar√° a pedidos ya guardados.</div>`, [
      {label:'Cancelar', variant:'secondary', onClick:()=>hideModal()},
      {label:'Eliminar', variant:'danger', onClick:()=>{ delete db.proveedores[provName]; saveDB(); hideModal(); updateAllSelects(); updateResumenSelect(); renderGestionProveedores(); showToast('Proveedor eliminado.'); }}
    ]);
  };
  ctrl.appendChild(btnEdit); ctrl.appendChild(btnDelete);
  header.appendChild(ctrl);
  cont.appendChild(header);

  const productosOrdenados = [...(data.productos||[])].sort((a,b)=>a.localeCompare(b,'es',{sensitivity:'base'}));
  productosOrdenados.forEach((p, idx)=>{
    const row = create('div',{class:'product-item'});
    row.appendChild(create('div',{class:'pname'}, escapeHtml(p)));
    const actions=create('div',{style:'display:flex;gap:6px'});
    const bEdit = create('button',{class:'btn icon secondary'},'‚úèÔ∏è');
    bEdit.onclick = ()=>{ const nuevo = prompt('Renombrar producto:', p); if(nuevo && nuevo.trim()){ const origIdx = (data.productos||[]).indexOf(p); if(origIdx>-1){ data.productos[origIdx] = nuevo.trim(); saveDB(); renderGestionProveedores(); showToast('Producto renombrado.'); } } };
    const bDel = create('button',{class:'btn icon danger'},'üóëÔ∏è');
    bDel.onclick = ()=>{ const origIdx = (data.productos||[]).indexOf(p); if(origIdx>-1){ data.productos.splice(origIdx,1); saveDB(); renderGestionProveedores(); showToast('Producto eliminado.'); } };
    actions.appendChild(bEdit); actions.appendChild(bDel);
    row.appendChild(actions);
    cont.appendChild(row);
  });

  const add = create('div',{class:'add-product-wrap'});
  const input = create('input',{id:'nuevoProducto',placeholder:'A√±adir producto (p.ej. Calamar anilla 1 kg)'});
  const btnAdd = create('button',{class:'btn'},'A√±adir');
  btnAdd.onclick = ()=>{ const p=(input.value||'').trim(); if(!p){ showToast('Escribe un producto.','warn'); return; } if(data.productos.includes(p)){ showToast('Ese producto ya existe.','warn'); return; } data.productos.push(p); saveDB(); input.value=''; renderGestionProveedores(); showToast('Producto a√±adido.'); };
  add.appendChild(input); add.appendChild(btnAdd); cont.appendChild(add);
}

/* ========== Pedidos ========== */
function clearProductosPedido(){ $('#productosPedido').innerHTML=''; }
function mostrarProductosPedido(){
const cont=$('#productosPedido'); cont.innerHTML='';
const prov = $('#pedidoProveedorSelect').value;
if(!prov){ showToast('Elige un proveedor.','warn'); return; }
const data = db.proveedores[prov];
if(!data){ cont.innerHTML='<div>No encontrado.</div>'; return; }

// UI: A√±adir producto directamente desde Pedidos
const add = create('div',{class:'add-product-wrap'});
const input = create('input',{id:'nuevoProductoPedido',placeholder:'A√±adir producto nuevo a este proveedor'});
const btnAdd = create('button',{class:'btn'},'A√±adir');
btnAdd.onclick = ()=>{
  const p=(input.value||'').trim();
  if(!p){ showToast('Escribe un producto.','warn'); return; }
  if((data.productos||[]).includes(p)){ showToast('Ese producto ya existe.','warn'); return; }
  data.productos = [...(data.productos||[]), p];
  saveDB();
  input.value='';
  mostrarProductosPedido();
  showToast('Producto a√±adido.');
};
add.appendChild(input); add.appendChild(btnAdd);
cont.appendChild(add);

if(!data.productos || data.productos.length===0){
  cont.appendChild(create('div',{style:'opacity:.75'}, 'Este proveedor no tiene productos. A√±√°delos arriba.'));
  return;
}

const productosOrdenados = [...(data.productos||[])].sort((a,b)=>a.localeCompare(b,'es',{sensitivity:'base'}));
productosOrdenados.forEach((p,i)=>{
  const row = create('div',{class:'product-item'});
  const qtyWrap = create('div',{class:'qty'});
  const qty = create('input',{type:'number',min:'0',step:'0.5',value:'1','aria-label':'Cantidad'});
  qtyWrap.appendChild(qty);
  const umWrap = create('div',{class:'um'});
  const um = create('select',{'aria-label':'Tipo'}, `
    <option value="caja/s" selected>caja/s</option>
    <option value="estuche/s">estuche/s</option>
    <option value="bolsa/s">bolsa/s</option>
  `);
  umWrap.appendChild(um);
  const name = create('div',{class:'pname','aria-label':'Producto'}, escapeHtml(p));
  const chkWrap = create('div',{class:'chk'});
  const chk = create('input',{type:'checkbox','aria-label':'Seleccionar'});
  chkWrap.appendChild(chk);
  row.appendChild(qtyWrap); row.appendChild(umWrap); row.appendChild(name); row.appendChild(chkWrap);
  cont.appendChild(row);
});
}
function recogerSeleccion(){
  const rows = document.querySelectorAll('#productosPedido .product-item');
  const items = [];
  rows.forEach(r=>{
    const chk = r.querySelector('.chk input[type="checkbox"]');
    const name = r.querySelector('.pname')?.textContent?.trim();
    const qty = parseFloat(r.querySelector('.qty input')?.value || '0');
    const um = r.querySelector('.um select')?.value || 'caja/s';
    if(chk && chk.checked && name && qty>0){ items.push({producto:name,cantidad:qty,unidad:um}); }
  });
  return items;
}
function revisarPedidoDesdePantalla(){
  const prov = $('#pedidoProveedorSelect').value;
  if(!prov){ showToast('Elige un proveedor.','warn'); return; }
  revisarPedido(prov);
}
function enviarPedidoDesdePantalla(){
  const prov = $('#pedidoProveedorSelect').value;
  if(!prov){ showToast('Elige un proveedor.','warn'); return; }
  enviarPedido(prov, true);
}
function revisarPedido(proveedor){
  const items = recogerSeleccion();
  if(items.length===0){ showToast('Selecciona al menos un producto con cantidad.','warn'); return; }
  const html = `
    <div style="line-height:1.5">
      <div><strong>Proveedor:</strong> ${escapeHtml(proveedor)}</div>
      <ul style="margin:8px 0 0 18px">
        ${items.map(it=>`<li><strong>${it.cantidad}</strong> ${escapeHtml(it.unidad)} ${escapeHtml(it.producto)}</li>`).join('')}
      </ul>
    </div>`;
  showModal('Revisar pedido', html, [
    {label:'Atr√°s', variant:'secondary', onClick:()=>hideModal()},
    {label:'Confirmar y enviar', onClick:()=>{ hideModal(); enviarPedido(proveedor,false,items); }}
  ]);
}
function componerTextoPedido(proveedor, items){
  let lines = [];
  lines.push(`Pedido para ${proveedor}`);
  items.forEach(it=> lines.push(`${it.cantidad} ${it.unidad} ${it.producto}`));
  return lines.join('\n');
}
function guardarPedidoEnDB(proveedor, items){
  const id = 'P'+Date.now();
  db.pedidos[id] = { id, proveedor, fecha: new Date().toISOString(), items, enviado: false };
  saveDB();
  return id;
}
async function copiarAlPortapapeles(texto){
  try{ await navigator.clipboard.writeText(texto); showToast('Texto copiado.'); }
  catch(e){ showToast('No se pudo copiar.','warn'); }
}
function normalizarTelefono(p){ if(!p) return ''; let t=String(p).replace(/[^\d+]/g,''); if(t.startsWith('00')) t='+'+t.slice(2); if(/^\d{9,15}$/.test(t)) return t; if(/^\+\d{8,15}$/.test(t)) return t.replace('+',''); return t.replace('+',''); }
function enviarPedido(proveedor, _skip=false, preItems=null){
  const items = preItems || recogerSeleccion();
  if(items.length===0){ showToast('Selecciona productos y cantidades.','warn'); return; }
  const id = guardarPedidoEnDB(proveedor, items);
  const texto = componerTextoPedido(proveedor, items);
  const telefono = (db.proveedores[proveedor]?.telefono||'').trim();
  const phoneWA = normalizarTelefono(telefono);
  if(phoneWA){
    const url = `https://wa.me/${encodeURIComponent(phoneWA)}?text=${encodeURIComponent(texto)}`;
    window.open(url, '_blank');
    db.pedidos[id].enviado = true; saveDB();
    showToast('Pedido guardado y abierto en WhatsApp.');
  }else{
    showModal('Sin tel√©fono', `<div>Este proveedor no tiene tel√©fono guardado. Copia el texto y env√≠alo por tu canal.</div><pre style="white-space:pre-wrap;background:#f8fafc;border:1px solid #eef5fb;padding:8px;border-radius:8px;max-height:220px;overflow:auto;margin-top:8px">${escapeHtml(texto)}</pre>`, [
      {label:'Cerrar', variant:'secondary', onClick:()=>hideModal()},
      {label:'Copiar texto', onClick:()=>{ copiarAlPortapapeles(texto); hideModal(); }}
    ]);
    showToast('Pedido guardado. A√±ade el tel√©fono en Gesti√≥n para usar WhatsApp.','warn');
  }
  if(!$('#view-resumen').classList.contains('hidden')){ filtrarResumen(); }
}

/* ========== Resumen / Historial ========== */
function filtrarResumen(){
  const cont=$('#historialContainer');
  cont.innerHTML='';
  const prov = $('#resumenProveedorSelect').value;
  const iniVal = $('#resumenInicio').value;
  const finVal = $('#resumenFin').value;
  if(!prov){ cont.innerHTML = '<div style="opacity:.7">Selecciona un proveedor y pulsa <strong>Buscar</strong>.</div>'; return; }
  const ini = iniVal ? new Date(iniVal+'T00:00:00') : null;
  const fin = finVal ? new Date(finVal+'T23:59:59') : null;
  const arr = Object.values(db.pedidos||{});
  const filtrados = arr.filter(p=>{
    if(p.proveedor!==prov) return false;
    const f = new Date(p.fecha);
    if(ini && f<ini) return false;
    if(fin && f>fin) return false;
    return true;
  }).sort((a,b)=> new Date(b.fecha)-new Date(a.fecha));
  if(filtrados.length===0){ cont.innerHTML = '<div style="opacity:.7">Sin resultados para ese proveedor/rango.</div>'; return; }
  filtrados.forEach(p=>{
    const card=create('div',{class:'product-item'});
    const resumen = `${p.items.map(i=>`${i.cantidad} ${i.unidad} ${i.producto}`).join(', ')}`;
    const left=create('div',{style:'flex:3'},
      `<div style="font-weight:700">${escapeHtml(p.proveedor)}</div>
       <div style="opacity:.75">${formatDT(new Date(p.fecha))} ${p.enviado? '¬∑ ‚úÖ enviado':''}</div>
       <div style="margin-top:4px">${escapeHtml(resumen)}</div>`
    );
    const actions = create('div',{style:'display:flex;gap:6px'});
    const bVer = create('button',{class:'btn icon secondary'},'üëÅÔ∏è'); bVer.onclick = ()=>verPedido(p.id);
    const bDel = create('button',{class:'btn icon danger'},'üóëÔ∏è'); bDel.onclick = ()=>eliminarPedido(p.id);
    actions.appendChild(bVer); actions.appendChild(bDel);
    card.appendChild(left); card.appendChild(actions);
    cont.appendChild(card);
  });
  const bRange = create('button',{class:'btn danger'},'Eliminar todos los pedidos del rango');
  bRange.onclick = ()=>eliminarRangoPedidos();
  cont.appendChild(bRange);
}
function verPedido(id){
  const p = db.pedidos[id];
  if(!p){ showToast('Pedido no encontrado.','warn'); return; }
  const html = `
    <div style="line-height:1.5">
      <div><strong>Proveedor:</strong> ${escapeHtml(p.proveedor)}</div>
      <div><strong>Fecha:</strong> ${formatDT(new Date(p.fecha))}</div>
      <ul style="margin:8px 0 0 18px">${p.items.map(i=>`<li><strong>${i.cantidad}</strong> ${escapeHtml(i.unidad)} ${escapeHtml(i.producto)}</li>`).join('')}</ul>
      <div style="margin-top:10px;opacity:.75">${p.enviado?'‚úÖ Enviado':'‚è≥ No enviado'}</div>
    </div>`;
  showModal('Detalle del pedido', html, [
    {label:'Cerrar', variant:'secondary', onClick:()=>hideModal()},
    {label:'Copiar texto', onClick:()=>copiarAlPortapapeles(componerTextoPedido(p.proveedor,p.items))}
  ]);
}
function eliminarPedido(id){
  const p = db.pedidos[id]; if(!p) return;
  showModal('Eliminar pedido', `<div>¬øEliminar el pedido a <strong>${escapeHtml(p.proveedor)}</strong> de ${formatDT(new Date(p.fecha))}?</div>`, [
    {label:'Cancelar', variant:'secondary', onClick:()=>hideModal()},
    {label:'Eliminar', variant:'danger', onClick:()=>{ delete db.pedidos[id]; saveDB(); hideModal(); filtrarResumen(); showToast('Pedido eliminado.'); }}
  ]);
}
function eliminarRangoPedidos(){
  const prov = $('#resumenProveedorSelect').value;
  const iniVal = $('#resumenInicio').value;
  const finVal = $('#resumenFin').value;
  if(!prov){ showToast('Selecciona proveedor.','warn'); return; }
  const ini = iniVal ? new Date(iniVal+'T00:00:00') : null;
  const fin = finVal ? new Date(finVal+'T23:59:59') : null;
  let ids = Object.values(db.pedidos||{}).filter(p=>{
    if(p.proveedor!==prov) return false;
    const f = new Date(p.fecha);
    if(ini && f<ini) return false;
    if(fin && f>fin) return false;
    return true;
  }).map(p=>p.id);
  if(ids.length===0){ showToast('Nada que borrar con ese filtro.','warn'); return; }
  showModal('Eliminar por rango', `<div>¬øEliminar <strong>${ids.length}</strong> pedidos filtrados?</div>`, [
    {label:'Cancelar', variant:'secondary', onClick:()=>hideModal()},
    {label:'Eliminar', variant:'danger', onClick:()=>{ ids.forEach(id=>delete db.pedidos[id]); saveDB(); hideModal(); filtrarResumen(); showToast('Pedidos eliminados.'); }}
  ]);
}

/* ========== Exportar / Importar ========== */
function exportarDB(){
  const dataStr = JSON.stringify(db, null, 2);
  const blob = new Blob([dataStr], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `timon_backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
  URL.revokeObjectURL(url);
  showToast('Copia exportada correctamente.');
}
function importarDB(ev){
  const file = ev.target.files[0];
  if(!file){ showToast('No se seleccion√≥ archivo.','warn'); return; }
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      if(!data.proveedores || !data.pedidos) throw new Error();
      db = data; saveDB();
      updateAllSelects(); updateResumenSelect(); renderGestionProveedores();
      showToast('Datos importados correctamente.'); showMain();
    } catch(err) {
      showToast('Archivo inv√°lido.','error');
    }
  };
  reader.readAsText(file);
}

/* ========== Init ========== */
function goBackToMain(){ showMain(); window.scrollTo({ top:0, behavior:'smooth' }); }
function init(){
  db = JSON.parse(localStorage.getItem(DB_KEY) || '{"proveedores":{},"pedidos":{}}');
  if(!db.proveedores) db.proveedores = {};
  if(!db.pedidos) db.pedidos = {};
  updateAllSelects(); updateResumenSelect(); renderGestionProveedores(); showMain();
}
init();
</script>
</body>
</html>
